<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONITOR GASOIL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #bbdefb;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            color: #90caf9;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header i {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .card-title {
            font-size: 1.3rem;
            color: #bbdefb;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .card-title i {
            font-size: 1.5rem;
        }
        
        .distance-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 250px;
        }
        
        .distance-visual {
            position: relative;
            width: 60px;
            height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 30px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .distance-bar {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #4CAF50, #8BC34A);
            border-radius: 30px;
            transition: height 1s ease;
            height: 0%;
        }
        
        .distance-labels {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 200px;
            position: absolute;
            left: -50px;
            font-size: 0.9rem;
            color: #bbdefb;
        }
        
        .distance-value-container {
            text-align: center;
            margin-top: 10px;
        }
        
        .distance-value {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .distance-label {
            font-size: 1.1rem;
            color: #bbdefb;
            margin-top: 5px;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .data-item {
            display: flex;
            flex-direction: column;
        }
        
        .data-label {
            font-size: 1rem;
            color: #bbdefb;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .data-value {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
            min-height: 45px;
            display: flex;
            align-items: center;
        }
        
        .data-unit {
            font-size: 1.2rem;
            color: #bbdefb;
            margin-left: 5px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 180px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2196F3 0%, #0d47a1 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0d8bf2 0%, #0a3d8f 100%);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.6);
            transform: translateY(-3px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.6);
            transform: translateY(-3px);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .status-footer {
            text-align: center;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            color: #bbdefb;
            font-size: 1.1rem;
        }
        
        .status-text {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .status-text i {
            font-size: 1.2rem;
        }
        
        .next-update {
            font-size: 1rem;
            color: #90caf9;
        }
        
        .error {
            color: #ff5252 !important;
        }
        
        .warning {
            color: #FF9800 !important;
        }
        
        .success {
            color: #4CAF50 !important;
        }
        
        .device-info {
            font-size: 0.9rem;
            color: #90caf9;
            text-align: center;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-gas-pump"></i> MONITOR GASOIL</h1>
            <p><i class="fas fa-sync-alt"></i> Actualizaci√≥n autom√°tica cada 30 segundos</p>
            <div id="data-status" class="status-text">Conectando...</div>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-ruler-vertical"></i> Distancia del sensor
                </div>
                <div class="distance-container">
                    <div class="distance-labels">
                        <div>100%</div>
                        <div>75%</div>
                        <div>50%</div>
                        <div>25%</div>
                        <div>0%</div>
                    </div>
                    <div class="distance-visual">
                        <div class="distance-bar"></div>
                    </div>
                    <div class="distance-value-container">
                        <div id="distance-value" class="distance-value">-- mm</div>
                        <div class="distance-label">Distancia del sensor</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-tachometer-alt"></i> Informaci√≥n del tanque
                </div>
                <div class="data-grid">
                    <div class="data-item">
                        <div class="data-label">
                            <i class="fas fa-percentage"></i> Nivel del tanque
                        </div>
                        <div id="tank-level" class="data-value">--%</div>
                    </div>
                    
                    <div class="data-item">
                        <div class="data-label">
                            <i class="fas fa-oil-can"></i> Contenido
                        </div>
                        <div id="tank-liters" class="data-value">--<span class="data-unit"> Litros</span></div>
                    </div>
                    
                    <div class="data-item">
                        <div class="data-label">
                            <i class="fas fa-battery-full"></i> Bater√≠a
                        </div>
                        <div id="battery" class="data-value">--<span class="data-unit"> V</span></div>
                    </div>
                    
                    <div class="data-item">
                        <div class="data-label">
                            <i class="fas fa-microchip"></i> Sensor
                        </div>
                        <div class="data-value">LDDS75</div>
                    </div>
                </div>
                
                <div class="data-grid" style="margin-top: 25px;">
                    <div class="data-item">
                        <div class="data-label">
                            <i class="far fa-clock"></i> √öltima lectura
                        </div>
                        <div id="last-reading" class="data-value">--:-- --/--/----</div>
                    </div>
                    
                    <div class="data-item">
                        <div class="data-label">
                            <i class="fas fa-database"></i> Estado datos
                        </div>
                        <div id="data-status-value" class="data-value">--</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="update-button" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Actualizar Ahora
            </button>
            <button id="force-ttn-button" class="btn btn-secondary">
                <i class="fas fa-bolt"></i> Forzar TTN
            </button>
        </div>
        
        <div class="status-footer">
            <div id="system-status" class="status-text">
                <i class="fas fa-circle-notch fa-spin"></i> Sistema iniciando...
            </div>
            <div id="next-update" class="next-update">Pr√≥xima actualizaci√≥n: --:--</div>
            <div class="device-info">
                Dispositivo: eui-a84041602187da56 | Aplicaci√≥n: nivelgasoil | Capacidad: 1100 Litros
            </div>
        </div>
    </div>

    <script>
        // ===============================
        // CONFIGURACI√ìN COMPLETA CON TUS PAR√ÅMETROS
        // ===============================
        const TTN_APP_ID = "nivelgasoil";
        const TTN_API_KEY = "NNSXS.PNG274Q2UJQLFHO5J6JUCW73KGKX76WF2QZZYLA.QQSVQS36KN7NMV4SDPCJUWWMRRADWCQDGNPDNSMWEPXRN7FFYABA";
        const DEVICE_ID = "eui-a84041602187da56";

        // PAR√ÅMETROS DEL TANQUE (basados en tus datos)
        const DIST_LLENO = 120;     // mm cuando hay 1100L (tanque lleno)
        const DIST_VACIO = 1900;    // mm cuando hay 0L (tanque vac√≠o)
        const VOL_MAX = 1100;       // litros totales del tanque

        // ===============================
        // FUNCIONES PRINCIPALES
        // ===============================

        /**
         * Consulta los datos m√°s recientes de TTN
         */
        async function fetchTTNData() {
            const url = `https://eu1.cloud.thethings.network/api/v3/as/applications/${TTN_APP_ID}/packages/storage/uplink_message?last=10m&order=-received_at&limit=1`;
            
            console.log("üîó Consultando TTN API v3...");
            console.log(`Aplicaci√≥n: ${TTN_APP_ID}`);
            console.log(`Dispositivo: ${DEVICE_ID}`);
            
            try {
                const response = await fetch(url, {
                    headers: {
                        "Authorization": `Bearer ${TTN_API_KEY}`,
                        "Accept": "application/json"
                    }
                });
                
                console.log(`üìä Status HTTP: ${response.status} ${response.statusText}`);
                
                if (response.status === 200) {
                    const text = await response.text();
                    
                    if (!text || text.trim() === "") {
                        console.log("‚ö†Ô∏è  Respuesta vac√≠a - No hay datos");
                        return null;
                    }
                    
                    try {
                        const data = JSON.parse(text);
                        console.log("‚úÖ JSON parseado correctamente");
                        
                        // Filtrar por nuestro dispositivo espec√≠fico
                        if (data.result && data.result.length > 0) {
                            console.log(`üì¶ Total mensajes recibidos: ${data.result.length}`);
                            
                            const filteredResults = data.result.filter(item => 
                                item.end_device_ids && 
                                item.end_device_ids.device_id === DEVICE_ID
                            );
                            
                            if (filteredResults.length > 0) {
                                console.log(`üéØ ${filteredResults.length} mensaje(s) para nuestro dispositivo`);
                                data.result = filteredResults;
                                return data;
                            } else {
                                console.log("‚ö†Ô∏è  Mensajes recibidos pero no para nuestro dispositivo");
                                console.log("Dispositivos en la respuesta:");
                                data.result.forEach((item, index) => {
                                    const devId = item.end_device_ids?.device_id || 'desconocido';
                                    console.log(`  ${index + 1}. ${devId}`);
                                });
                                return null;
                            }
                        } else {
                            console.log("‚ÑπÔ∏è  No hay mensajes en la respuesta");
                            return null;
                        }
                    } catch (jsonError) {
                        console.log(`‚ùå Error parseando JSON: ${jsonError.message}`);
                        if (text.length > 0) {
                            console.log(`üìÑ Primeros 500 caracteres: ${text.substring(0, 500)}`);
                        }
                        return null;
                    }
                } else if (response.status === 401) {
                    console.log("‚ùå Error 401 - API Key inv√°lida o expirada");
                    return null;
                } else if (response.status === 403) {
                    console.log("‚ùå Error 403 - Sin permisos para acceder a esta aplicaci√≥n");
                    return null;
                } else if (response.status === 404) {
                    console.log("‚ö†Ô∏è  Error 404 - No se encontr√≥ la aplicaci√≥n o no hay datos");
                    return null;
                } else {
                    console.log(`‚ùå Error HTTP ${response.status}`);
                    return null;
                }
            } catch (error) {
                console.log(`‚ùå Error de red: ${error.message}`);
                return null;
            }
        }

        /**
         * Decodifica el payload hexadecimal de TTN
         */
        function decodePayload(hexString) {
            if (!hexString || hexString.length < 2) {
                console.log("‚ö†Ô∏è  Payload vac√≠o o muy corto");
                return null;
            }
            
            try {
                console.log(`üìä Payload hexadecimal: ${hexString}`);
                
                // Convertir hex a bytes
                const bytes = [];
                for (let i = 0; i < hexString.length; i += 2) {
                    const byteStr = hexString.substr(i, 2);
                    const byte = parseInt(byteStr, 16);
                    if (!isNaN(byte)) {
                        bytes.push(byte);
                    }
                }
                
                console.log(`üìä Bytes decodificados: [${bytes.join(", ")}]`);
                console.log(`üìä Longitud: ${bytes.length} byte(s)`);
                
                // AN√ÅLISIS DEL PAYLOAD
                // Basado en LDDS75: primer byte = distancia en cm
                if (bytes.length >= 1) {
                    const distance_cm = bytes[0];
                    const distance_mm = distance_cm * 10; // Convertir a mm
                    
                    console.log(`üìè Distancia sensor: ${distance_cm} cm = ${distance_mm} mm`);
                    
                    // Mostrar bytes adicionales si existen
                    for (let i = 1; i < bytes.length; i++) {
                        console.log(`üìä Byte ${i}: ${bytes[i]} (0x${bytes[i].toString(16).padStart(2, '0')})`);
                    }
                    
                    return {
                        distance_cm: distance_cm,
                        distance_mm: distance_mm,
                        raw_bytes: bytes,
                        hex_payload: hexString
                    };
                }
                
                return null;
            } catch (error) {
                console.log(`‚ùå Error decodificando payload: ${error.message}`);
                return null;
            }
        }

        /**
         * Calcula el nivel del tanque basado en la distancia del sensor
         * Usando interpolaci√≥n lineal inversa como en tu c√≥digo
         */
        function calculateTankLevel(distance_mm) {
            // Validar que la distancia est√© dentro del rango esperado
            if (distance_mm < DIST_LLENO) {
                console.log(`‚ö†Ô∏è  Distancia ${distance_mm}mm < DIST_LLENO ${DIST_LLENO}mm - Ajustando`);
                distance_mm = DIST_LLENO;
            }
            if (distance_mm > DIST_VACIO) {
                console.log(`‚ö†Ô∏è  Distancia ${distance_mm}mm > DIST_VACIO ${DIST_VACIO}mm - Ajustando`);
                distance_mm = DIST_VACIO;
            }
            
            console.log(`üìê Par√°metros del tanque:`);
            console.log(`   DIST_LLENO (100%): ${DIST_LLENO} mm`);
            console.log(`   DIST_VACIO (0%): ${DIST_VACIO} mm`);
            console.log(`   Distancia medida: ${distance_mm} mm`);
            console.log(`   VOL_MAX: ${VOL_MAX} litros`);
            
            // C√°lculo de porcentaje (f√≥rmula de interpolaci√≥n lineal)
            // Cuando distance = DIST_VACIO ‚Üí 0%
            // Cuando distance = DIST_LLENO ‚Üí 100%
            const porcentaje = 100 * (DIST_VACIO - distance_mm) / (DIST_VACIO - DIST_LLENO);
            
            // C√°lculo de litros (interpolaci√≥n lineal inversa)
            const litros = VOL_MAX * (DIST_VACIO - distance_mm) / (DIST_VACIO - DIST_LLENO);
            
            console.log(`üìä Resultados c√°lculo:`);
            console.log(`   Porcentaje: ${porcentaje.toFixed(1)}%`);
            console.log(`   Litros: ${litros.toFixed(0)} L`);
            
            return {
                percentage: Math.round(porcentaje * 10) / 10, // 1 decimal
                liters: Math.round(litros),
                distance_mm: Math.round(distance_mm),
                distance_cm: Math.round(distance_mm / 10)
            };
        }

        /**
         * Formatea fecha para display
         */
        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return {
                dateStr: `${day}/${month}/${year}`,
                timeStr: `${hours}:${minutes}`,
                fullStr: `${hours}:${minutes} ${day}/${month}/${year}`
            };
        }

        /**
         * Actualiza la interfaz con los datos
         */
        function updateDisplay(data, decodedData, tankData) {
            const now = new Date();
            
            console.log("üñ•Ô∏è  Actualizando interfaz...");
            
            // 1. ACTUALIZAR DISTANCIA DEL SENSOR
            const distanceElement = document.querySelector("#distance-value");
            if (distanceElement) {
                if (decodedData) {
                    distanceElement.textContent = `${decodedData.distance_mm} mm`;
                    console.log(`üìç Distancia actualizada: ${decodedData.distance_mm} mm`);
                } else {
                    distanceElement.textContent = "-- mm";
                    console.log("üìç Distancia: Sin datos");
                }
            }
            
            // 2. ACTUALIZAR BARRA DE NIVEL VISUAL
            const distanceBar = document.querySelector(".distance-bar");
            if (distanceBar && decodedData) {
                // Calcular altura de la barra (0-100%)
                const barHeight = 100 * (DIST_VACIO - decodedData.distance_mm) / (DIST_VACIO - DIST_LLENO);
                const clampedHeight = Math.max(0, Math.min(100, barHeight));
                
                distanceBar.style.height = `${clampedHeight}%`;
                console.log(`üìä Barra visual: ${clampedHeight.toFixed(1)}% de altura`);
                
                // Cambiar color seg√∫n nivel
                if (clampedHeight < 20) {
                    distanceBar.style.backgroundColor = "#f44336"; // Rojo (bajo)
                } else if (clampedHeight < 50) {
                    distanceBar.style.backgroundColor = "#FF9800"; // Naranja (medio)
                } else {
                    distanceBar.style.backgroundColor = "#4CAF50"; // Verde (alto)
                }
            }
            
            // 3. ACTUALIZAR NIVEL DEL TANQUE
            const tankLevelElement = document.querySelector("#tank-level");
            const tankLitersElement = document.querySelector("#tank-liters");
            
            if (tankLevelElement && tankLitersElement) {
                if (tankData) {
                    tankLevelElement.textContent = `${tankData.percentage}%`;
                    tankLitersElement.textContent = `${tankData.liters} Litros`;
                    
                    // Color seg√∫n nivel
                    if (tankData.percentage < 20) {
                        tankLevelElement.style.color = "#f44336";
                        tankLitersElement.style.color = "#f44336";
                    } else if (tankData.percentage < 50) {
                        tankLevelElement.style.color = "#FF9800";
                        tankLitersElement.style.color = "#FF9800";
                    } else {
                        tankLevelElement.style.color = "#4CAF50";
                        tankLitersElement.style.color = "#4CAF50";
                    }
                    
                    console.log(`üõ¢Ô∏è  Tanque: ${tankData.percentage}% (${tankData.liters} L)`);
                } else {
                    tankLevelElement.textContent = "--%";
                    tankLitersElement.textContent = "-- Litros";
                    tankLevelElement.style.color = "#757575";
                    tankLitersElement.style.color = "#757575";
                    console.log("üõ¢Ô∏è  Tanque: Sin datos");
                }
            }
            
            // 4. ACTUALIZAR BATER√çA
            const batteryElement = document.querySelector("#battery");
            if (batteryElement) {
                if (data && data.result && data.result[0]) {
                    const uplink = data.result[0].uplink_message;
                    
                    // Intentar obtener bater√≠a de diferentes fuentes
                    let batteryVoltage = null;
                    
                    if (uplink && uplink.decoded_payload && uplink.decoded_payload.battery) {
                        batteryVoltage = uplink.decoded_payload.battery;
                    } else if (decodedData && decodedData.raw_bytes && decodedData.raw_bytes.length >= 2) {
                        // Si el segundo byte parece ser voltaje (ej: 33 = 3.3V)
                        const batteryByte = decodedData.raw_bytes[1];
                        if (batteryByte >= 20 && batteryByte <= 45) {
                            batteryVoltage = (batteryByte / 10).toFixed(1);
                        }
                    }
                    
                    if (batteryVoltage) {
                        batteryElement.textContent = `${batteryVoltage} V`;
                        
                        // Color seg√∫n voltaje
                        if (batteryVoltage < 3.0) {
                            batteryElement.style.color = "#f44336";
                        } else if (batteryVoltage < 3.3) {
                            batteryElement.style.color = "#FF9800";
                        } else {
                            batteryElement.style.color = "#4CAF50";
                        }
                        
                        console.log(`üîã Bater√≠a: ${batteryVoltage} V`);
                    } else {
                        batteryElement.textContent = "-- V";
                        batteryElement.style.color = "#757575";
                        console.log("üîã Bater√≠a: No disponible");
                    }
                } else {
                    batteryElement.textContent = "-- V";
                    batteryElement.style.color = "#757575";
                }
            }
            
            // 5. ACTUALIZAR √öLTIMA LECTURA
            const lastReadingElement = document.querySelector("#last-reading");
            if (lastReadingElement) {
                if (data && data.result && data.result[0]) {
                    const receivedAt = new Date(data.result[0].received_at);
                    const formatted = formatDate(receivedAt);
                    lastReadingElement.textContent = formatted.fullStr;
                    console.log(`üïê √öltima lectura: ${formatted.fullStr}`);
                } else {
                    lastReadingElement.textContent = "--:-- --/--/----";
                    console.log("üïê √öltima lectura: Sin datos");
                }
            }
            
            // 6. ACTUALIZAR ESTADO DE DATOS
            const dataStatusElement = document.querySelector("#data-status");
            const dataStatusValueElement = document.querySelector("#data-status-value");
            
            if (dataStatusElement && dataStatusValueElement) {
                if (data && data.result && data.result[0]) {
                    dataStatusElement.textContent = "‚úÖ Conectado - Datos actuales";
                    dataStatusElement.className = "status-text success";
                    dataStatusValueElement.textContent = "OK";
                    dataStatusValueElement.className = "data-value success";
                } else {
                    dataStatusElement.textContent = "‚ö†Ô∏è Sin datos recientes";
                    dataStatusElement.className = "status-text warning";
                    dataStatusValueElement.textContent = "Sin datos";
                    dataStatusValueElement.className = "data-value warning";
                }
            }
            
            // 7. ACTUALIZAR PR√ìXIMA ACTUALIZACI√ìN
            const nextUpdateElement = document.querySelector("#next-update");
            if (nextUpdateElement) {
                const nextUpdate = new Date(now.getTime() + 30 * 1000);
                const formatted = formatDate(nextUpdate);
                nextUpdateElement.textContent = `Pr√≥xima actualizaci√≥n: ${formatted.timeStr}`;
            }
            
            // 8. ACTUALIZAR ESTADO DEL SISTEMA
            const systemStatusElement = document.querySelector("#system-status");
            if (systemStatusElement) {
                if (data && data.result && data.result[0]) {
                    systemStatusElement.innerHTML = '<i class="fas fa-check-circle"></i> Sistema operativo';
                    systemStatusElement.className = "status-text success";
                } else {
                    systemStatusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Esperando datos del sensor';
                    systemStatusElement.className = "status-text warning";
                }
            }
            
            console.log("‚úÖ Interfaz actualizada");
        }

        /**
         * Funci√≥n principal que orquesta todo el proceso
         */
        async function updateData() {
            console.log("=".repeat(60));
            console.log("üîÑ INICIANDO ACTUALIZACI√ìN DE DATOS");
            console.log("=".repeat(60));
            
            // Mostrar estado "Conectando..."
            const statusElement = document.querySelector("#data-status");
            if (statusElement) {
                statusElement.textContent = "Conectando...";
                statusElement.className = "status-text";
            }
            
            // 1. OBTENER DATOS DE TTN
            console.log("\nüì° PASO 1: Obteniendo datos de TTN");
            const ttnData = await fetchTTNData();
            
            let decodedData = null;
            let tankData = null;
            
            // 2. PROCESAR DATOS SI EXISTEN
            if (ttnData && ttnData.result && ttnData.result.length > 0) {
                console.log("\nüîç PASO 2: Procesando datos recibidos");
                
                const latestMessage = ttnData.result[0];
                const hexPayload = latestMessage.uplink_message?.frm_payload;
                
                if (hexPayload) {
                    console.log(`üì¶ Payload encontrado: ${hexPayload}`);
                    decodedData = decodePayload(hexPayload);
                    
                    if (decodedData) {
                        console.log("\nüßÆ PASO 3: Calculando nivel del tanque");
                        tankData = calculateTankLevel(decodedData.distance_mm);
                    } else {
                        console.log("‚ö†Ô∏è  No se pudo decodificar el payload");
                    }
                } else {
                    console.log("‚ö†Ô∏è  No hay payload en el mensaje");
                }
            } else {
                console.log("\n‚ö†Ô∏è  No se obtuvieron datos de TTN");
                console.log("Posibles causas:");
                console.log("1. El dispositivo no ha transmitido en los √∫ltimos 10 minutos");
                console.log("2. Problemas de conexi√≥n del dispositivo");
                console.log("3. Configuraci√≥n incorrecta en TTN");
                console.log("4. API Key sin permisos suficientes");
            }
            
            // 3. ACTUALIZAR INTERFAZ
            console.log("\nüé® PASO 4: Actualizando interfaz de usuario");
            updateDisplay(ttnData, decodedData, tankData);
            
            console.log("\n‚úÖ ACTUALIZACI√ìN COMPLETADA");
            console.log("=".repeat(60));
        }

        /**
         * Forzar actualizaci√≥n manual (para el bot√≥n)
         */
        function forceUpdate() {
            console.log("\nüîò Bot√≥n presionado: Forzando actualizaci√≥n manual");
            updateData();
        }

        // ===============================
        // INICIALIZACI√ìN DEL SISTEMA
        // ===============================
        document.addEventListener("DOMContentLoaded", function() {
            console.log("üöÄ SISTEMA DE MONITOREO INICIADO");
            console.log(`üìä Dispositivo: ${DEVICE_ID}`);
            console.log(`üìä Aplicaci√≥n TTN: ${TTN_APP_ID}`);
            console.log(`üìä Configuraci√≥n tanque:`);
            console.log(`   - Capacidad: ${VOL_MAX} litros`);
            console.log(`   - Distancia vac√≠o: ${DIST_VACIO} mm`);
            console.log(`   - Distancia lleno: ${DIST_LLENO} mm`);
            
            // Configurar botones
            const updateButton = document.querySelector("#update-button");
            const forceTTNButton = document.querySelector("#force-ttn-button");
            
            if (updateButton) {
                updateButton.addEventListener("click", forceUpdate);
                console.log("‚úÖ Bot√≥n 'Actualizar Ahora' configurado");
            }
            
            if (forceTTNButton) {
                forceTTNButton.addEventListener("click", forceUpdate);
                console.log("‚úÖ Bot√≥n 'Forzar TTN' configurado");
            }
            
            // Realizar primera actualizaci√≥n
            setTimeout(() => {
                updateData();
            }, 1000);
            
            // Configurar actualizaci√≥n autom√°tica cada 30 segundos
            setInterval(updateData, 30000);
            console.log("‚è∞ Actualizaci√≥n autom√°tica configurada cada 30 segundos");
            
            console.log("=".repeat(60));
        });

        /**
         * Funci√≥n para debug: Mostrar todos los datos crudos
         */
        function debugShowRawData(data) {
            if (data && data.result && data.result[0]) {
                console.log("üîç DATOS CRUDOS COMPLETOS:");
                console.log(JSON.stringify(data.result[0], null, 2));
            }
        }
    </script>
</body>
</html>
