<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Monitor Gasoil - FUNCIONANDO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --warning: #ea580c;
            --danger: #dc2626;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; min-height: 100vh; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        h1 { text-align: center; margin-bottom: 10px; font-size: 28px; background: linear-gradient(90deg, #60a5fa, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { text-align: center; color: #94a3b8; margin-bottom: 30px; }
        .distance-display { text-align: center; margin: 40px 0; }
        .distance-value { font-size: 100px; font-weight: 800; background: linear-gradient(90deg, #60a5fa, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1; }
        .distance-unit { font-size: 24px; color: #94a3b8; margin-left: 10px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 30px 0; }
        .info-item { background: rgba(15, 23, 42, 0.7); padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary); }
        .info-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .info-value { font-size: 24px; font-weight: 700; }
        .btn { display: block; width: 100%; padding: 18px; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin: 10px 0; }
        .btn-primary { background: linear-gradient(90deg, #3b82f6, #2563eb); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .status { padding: 15px; border-radius: 10px; text-align: center; margin: 20px 0; font-weight: 600; }
        .status-success { background: rgba(22, 163, 74, 0.2); border: 1px solid rgba(22, 163, 74, 0.4); color: #4ade80; }
        .status-warning { background: rgba(234, 88, 12, 0.2); border: 1px solid rgba(234, 88, 12, 0.4); color: #fb923c; }
        .status-error { background: rgba(220, 38, 38, 0.2); border: 1px solid rgba(220, 38, 38, 0.4); color: #f87171; }
        .last-update { text-align: center; color: #64748b; font-size: 14px; margin-top: 20px; }
        @media (max-width: 600px) {
            .distance-value { font-size: 80px; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üõ¢Ô∏è MONITOR GASOIL</h1>
            <p class="subtitle">Datos en tiempo real ‚Ä¢ TTN API v3</p>
            
            <div id="status" class="status status-warning">
                üîÑ Conectando a TTN...
            </div>
            
            <div class="distance-display">
                <div class="distance-value">
                    <span id="distance">--</span><span class="distance-unit">mm</span>
                </div>
                <div style="color: #94a3b8; margin-top: 10px;">Distancia del sensor</div>
            </div>
            
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Nivel Estimado</div>
                    <div class="info-value" id="level">--%</div>
                    <div style="font-size: 14px; color: #94a3b8;" id="liters">-- L</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Bater√≠a</div>
                    <div class="info-value" id="battery">-- V</div>
                    <div style="font-size: 14px; color: #94a3b8;">Sensor LDDS75</div>
                </div>
                <div class="info-item">
                    <div class="info-label">√öltima Lectura</div>
                    <div class="info-value" id="time">--:--</div>
                    <div style="font-size: 14px; color: #94a3b8;" id="date">--/--/----</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Estado</div>
                    <div class="info-value" id="source">--</div>
                    <div style="font-size: 14px; color: #94a3b8;" id="device">Dispositivo</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="updateData()" id="updateBtn">
                üîÑ Actualizar Datos
            </button>
            
            <button class="btn btn-secondary" onclick="forceFetchFromTTN()">
                ‚ö° Consultar TTN API
            </button>
            
            <div class="last-update" id="lastUpdate">
                Cargando...
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxEHHmB9cSJ7H5KUyXvy8GZf98pGPnMWZhYT7OdLHjPw4nXxjORyZf7W_8vm_MJU6_mUg/exec';
        const SIMPLE_URL = SCRIPT_URL + '?format=simple';
        
        let lastData = null;
        let lastUpdateTime = null;
        
        async function updateData(showLoading = true) {
            const btn = document.getElementById('updateBtn');
            const originalText = btn.innerHTML;
            
            if (showLoading) {
                btn.innerHTML = 'üîÑ Actualizando...';
                btn.disabled = true;
                setStatus('warning', 'üîÑ Actualizando datos...');
            }
            
            try {
                const response = await fetch(SIMPLE_URL);
                const data = await response.json();
                
                lastData = data;
                lastUpdateTime = new Date();
                
                updateDisplay(data);
                
                if (data.is_real) {
                    setStatus('success', '‚úÖ Datos reales de TTN API');
                } else {
                    setStatus('warning', '‚ö†Ô∏è Modo simulado - Presiona "Consultar TTN API"');
                }
                
                updateLastUpdateText();
                
            } catch (error) {
                setStatus('error', '‚ùå Error de conexi√≥n');
                console.error('Error:', error);
            } finally {
                if (showLoading) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }
        
        async function forceFetchFromTTN() {
            setStatus('warning', '‚ö° Consultando TTN API...');
            
            try {
                const response = await fetch(SCRIPT_URL + '?force=fetch');
                const data = await response.json();
                
                if (data.success) {
                    setStatus('success', '‚úÖ Datos obtenidos de TTN');
                    alert(`‚úÖ ${data.message}\n\nDistancia: ${data.data.distance} mm\nBater√≠a: ${data.data.battery} V`);
                    
                    // Actualizar display
                    setTimeout(() => updateData(false), 1000);
                } else {
                    setStatus('error', '‚ùå Error obteniendo datos');
                    alert(`‚ö†Ô∏è ${data.message || data.error}`);
                }
                
            } catch (error) {
                setStatus('error', '‚ùå Error de conexi√≥n');
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        function updateDisplay(data) {
            // Distancia
            document.getElementById('distance').textContent = data.distance;
            
            // Nivel calculado
            const level = calculateLevel(data.distance);
            document.getElementById('level').textContent = level.percent + '%';
            document.getElementById('level').style.color = getLevelColor(level.percent);
            document.getElementById('liters').textContent = level.liters + ' L';
            
            // Bater√≠a
            document.getElementById('battery').textContent = data.battery.toFixed(2) + ' V';
            document.getElementById('battery').style.color = getBatteryColor(data.battery);
            
            // Tiempo
            const timeInfo = formatDateTime(data.timestamp);
            document.getElementById('time').textContent = timeInfo.time;
            document.getElementById('date').textContent = timeInfo.date;
            
            // Estado
            document.getElementById('source').textContent = data.is_real ? 'ONLINE' : 'SIMULADO';
            document.getElementById('source').style.color = data.is_real ? '#4ade80' : '#fb923c';
            document.getElementById('device').textContent = data.is_real ? 'TTN API v3' : 'Modo local';
            
            console.log('Display actualizado:', data);
        }
        
        function setStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = 'status status-' + type;
            statusEl.innerHTML = message;
        }
        
        function calculateLevel(distance) {
            const TANK = {
                full: 120,    // mm cuando est√° lleno (1100L)
                empty: 1900,  // mm cuando est√° vac√≠o (0L)
                capacity: 1100 // litros totales
            };
            
            let liters = TANK.capacity * (TANK.empty - distance) / (TANK.empty - TANK.full);
            if (liters < 0) liters = 0;
            if (liters > TANK.capacity) liters = TANK.capacity;
            
            const percent = Math.round((liters / TANK.capacity) * 100);
            
            return {
                liters: Math.round(liters),
                percent: percent
            };
        }
        
        function getLevelColor(percent) {
            if (percent >= 60) return '#4ade80'; // Verde
            if (percent >= 20) return '#fbbf24'; // Amarillo
            return '#f87171'; // Rojo
        }
        
        function getBatteryColor(voltage) {
            if (voltage >= 3.6) return '#4ade80'; // Bueno
            if (voltage >= 3.3) return '#fbbf24'; // Medio
            return '#f87171'; // Bajo
        }
        
        function formatDateTime(timestamp) {
            if (!timestamp) return { time: '--:--', date: '--/--/----' };
            
            try {
                const date = new Date(timestamp);
                return {
                    time: date.toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit'
                    }),
                    date: date.toLocaleDateString('es-ES')
                };
            } catch (e) {
                return {
                    time: timestamp.substring(11, 16) || '--:--',
                    date: timestamp.substring(0, 10) || '--/--/----'
                };
            }
        }
        
        function updateLastUpdateText() {
            if (!lastUpdateTime) return;
            
            const now = new Date();
            const diffMs = now - lastUpdateTime;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            
            let text = 'Actualizado ahora';
            
            if (diffSec > 0) {
                if (diffSec < 60) {
                    text = `Actualizado hace ${diffSec} segundos`;
                } else if (diffMin < 60) {
                    text = `Actualizado hace ${diffMin} minuto${diffMin > 1 ? 's' : ''}`;
                } else {
                    const hours = Math.floor(diffMin / 60);
                    text = `Actualizado hace ${hours} hora${hours > 1 ? 's' : ''}`;
                }
            }
            
            if (lastData && !lastData.is_real) {
                text += ' ‚Ä¢ Modo simulado';
            }
            
            document.getElementById('lastUpdate').textContent = text;
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Monitor Gasoil iniciado');
            console.log('URLs:', { SCRIPT_URL, SIMPLE_URL });
            
            // Actualizar inmediatamente
            updateData();
            
            // Auto-actualizar cada 30 segundos
            setInterval(updateData, 30000);
            
            // Actualizar contador cada segundo
            setInterval(updateLastUpdateText, 1000);
        });
    </script>
</body>
</html>
