<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Webhook TTN</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        .btn { background: #4285f4; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; margin: 10px 5px; }
        .btn:hover { background: #3367d6; }
        .result { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background: #e8f5e9; border-left: 5px solid #4caf50; }
        .error { background: #ffebee; border-left: 5px solid #f44336; }
        .info { background: #e3f2fd; border-left: 5px solid #2196f3; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow: auto; }
    </style>
</head>
<body>
    <h1>üß™ Prueba Webhook TTN</h1>
    
    <div>
        <button class="btn" onclick="getData()">üì° Obtener Datos</button>
        <button class="btn" onclick="testDecodedPayload()">üîß Probar decoded_payload</button>
        <button class="btn" onclick="testNormalized()">üîÑ Probar formato normalizado</button>
        <button class="btn" onclick="forceDeviceMessage()">üì° Forzar mensaje dispositivo</button>
    </div>
    
    <div id="result" class="result"></div>
    
    <div class="info">
        <h3>üìã Instrucciones:</h3>
        <ol>
            <li>Primero haz clic en "Obtener Datos" para ver el estado actual</li>
            <li>Luego prueba con "Probar decoded_payload" (deber√≠a funcionar)</li>
            <li>Si no funciona, ve a TTN y cambia el formato del webhook a "Leave as is"</li>
            <li>Finalmente, haz que tu dispositivo env√≠e un mensaje real</li>
        </ol>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxEHHmB9cSJ7H5KUyXvy8GZf98pGPnMWZhYT7OdLHjPw4nXxjORyZf7W_8vm_MJU6_mUg/exec';
        
        function showResult(type, title, content) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result ' + type;
            resultDiv.innerHTML = `<h3>${title}</h3><pre>${JSON.stringify(content, null, 2)}</pre>`;
        }
        
        async function getData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                if (data.success) {
                    showResult('success', '‚úÖ Datos REALES del webhook', data);
                } else {
                    showResult('error', '‚ö†Ô∏è Modo RESPALDO (sin webhook a√∫n)', data);
                }
            } catch (error) {
                showResult('error', '‚ùå Error de conexi√≥n', { error: error.message });
            }
        }
        
        async function testDecodedPayload() {
            // Formato CORRECTO (decoded_payload)
            const testData = {
                received_at: new Date().toISOString(),
                uplink_message: {
                    decoded_payload: {
                        Bat: 3.42,
                        Distance: "1550 mm",
                        TempC_DS18B20: "19.0",
                        Interrupt_flag: 0,
                        Sensor_flag: 1
                    },
                    frm_payload: "TEST_DECODED"
                },
                end_device_ids: {
                    device_id: "eui-a84041602187da56"
                }
            };
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                showResult('info', 'üß™ Prueba decoded_payload enviada', data);
                
                // Esperar y actualizar
                setTimeout(getData, 1500);
                
            } catch (error) {
                showResult('error', '‚ùå Error en prueba', { error: error.message });
            }
        }
        
        async function testNormalized() {
            // Formato "normalized" (puede que sea lo que env√≠a TTN)
            const testData = {
                message: {
                    uplink_message: {
                        received_at: new Date().toISOString(),
                        decoded_payload: {
                            Bat: 3.44,
                            Distance: "1600 mm",
                            TempC_DS18B20: "20.0"
                        }
                    }
                },
                device_id: "eui-a84041602187da56"
            };
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                showResult('info', 'üîÑ Prueba formato normalizado', data);
                
                setTimeout(getData, 1500);
                
            } catch (error) {
                showResult('error', '‚ùå Error', { error: error.message });
            }
        }
        
        function forceDeviceMessage() {
            alert('Para forzar un mensaje real:\n\n1. Reinicia tu sensor LDDS75\n2. O espera su pr√≥ximo env√≠o autom√°tico\n\nLos sensores normalmente env√≠an cada 1-4 horas.');
        }
        
        // Auto-probar al cargar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('URL del script:', SCRIPT_URL);
            getData();
        });
    </script>
</body>
</html>
