<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Monitor Gasoil - API TTN v3</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #0d1117; color: white; }
        .container { max-width: 500px; margin: 0 auto; background: #161b22; padding: 30px; border-radius: 15px; border: 1px solid #30363d; }
        h1 { color: #58a6ff; text-align: center; margin-bottom: 30px; }
        .display { background: #0d1117; color: #7ee787; font-size: 72px; text-align: center; padding: 40px; margin: 20px 0; border-radius: 10px; border: 1px solid #30363d; font-family: 'Courier New', monospace; }
        .info { background: #21262d; padding: 20px; border-radius: 10px; margin: 15px 0; border: 1px solid #30363d; }
        .btn { background: #238636; color: white; padding: 15px; width: 100%; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin: 10px 0; font-weight: bold; }
        .btn:hover { background: #2ea043; }
        .btn-secondary { background: #21262d; border: 1px solid #30363d; }
        .btn-secondary:hover { background: #30363d; }
        .status { padding: 12px; border-radius: 6px; text-align: center; margin: 15px 0; border: 1px solid; }
        .online { background: #13233a; color: #58a6ff; border-color: #1f6feb; }
        .offline { background: #3d1d28; color: #f85149; border-color: #da3633; }
        .loading { background: #2d2d2d; color: #e3b341; border-color: #e3b341; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ¢Ô∏è MONITOR GASOIL</h1>
        
        <div id="status" class="status loading">
            üîÑ Iniciando...
        </div>
        
        <div class="display">
            <span id="distance">--</span><span style="font-size: 24px;"> mm</span>
        </div>
        
        <div class="info">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>üìä Nivel:</span>
                <span id="level" style="color: #7ee787;">-- L (--%)</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>üîã Bater√≠a:</span>
                <span id="battery" style="color: #58a6ff;">-- V</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>‚è∞ Actualizado:</span>
                <span id="time" style="color: #e3b341;">--:--:--</span>
            </div>
        </div>
        
        <button class="btn" onclick="updateData()" id="updateBtn">
            üîÑ Actualizar Datos
        </button>
        
        <button class="btn btn-secondary" onclick="forceFetch()">
            ‚ö° Consultar TTN API
        </button>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #30363d; text-align: center; font-size: 12px; color: #8b949e;">
            <p>API TTN v3 ‚Ä¢ Aplicaci√≥n: nivelgasoil</p>
            <p id="sourceInfo" style="color: #e3b341;">Conectando...</p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxEHHmB9cSJ7H5KUyXvy8GZf98pGPnMWZhYT7OdLHjPw4nXxjORyZf7W_8vm_MJU6_mUg/exec';
        
        // Configuraci√≥n del tanque
        const TANK = {
            full: 120,    // mm cuando est√° lleno (1100L)
            empty: 1900,  // mm cuando est√° vac√≠o (0L)
            capacity: 1100 // litros totales
        };
        
        async function updateData() {
            const btn = document.getElementById('updateBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'üîÑ Actualizando...';
            btn.disabled = true;
            
            setStatus('loading', 'üîÑ Actualizando datos...');
            
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                updateDisplay(data);
                
                if (data.success) {
                    setStatus('online', '‚úÖ Datos reales de TTN API v3');
                } else {
                    setStatus('offline', '‚ö†Ô∏è Modo simulado - Usa "Consultar TTN API"');
                }
                
            } catch (error) {
                setStatus('offline', '‚ùå Error de conexi√≥n');
                console.error('Error:', error);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function forceFetch() {
            setStatus('loading', '‚ö° Consultando API TTN...');
            
            try {
                const response = await fetch(SCRIPT_URL + '?force=fetch');
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ ${data.message}\n\nDistancia: ${data.data.distance} mm\nBater√≠a: ${data.data.battery} V`);
                    updateDisplay(data);
                    setStatus('online', '‚úÖ Datos obtenidos de TTN API');
                } else {
                    alert(`‚ö†Ô∏è ${data.message || data.error}`);
                    setStatus('offline', '‚ö†Ô∏è No se pudieron obtener datos');
                }
                
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                setStatus('offline', '‚ùå Error de conexi√≥n');
            }
        }
        
        function updateDisplay(data) {
            // Actualizar distancia
            document.getElementById('distance').textContent = data.data.distance;
            
            // Calcular y mostrar nivel
            const level = calculateLevel(data.data.distance);
            document.getElementById('level').textContent = `${level.liters} L (${level.percent}%)`;
            document.getElementById('level').style.color = getLevelColor(level.percent);
            
            // Mostrar bater√≠a
            document.getElementById('battery').textContent = data.data.battery.toFixed(2) + ' V';
            
            // Mostrar tiempo
            document.getElementById('time').textContent = formatTime(data.data.timestamp);
            
            // Mostrar fuente
            const sourceEl = document.getElementById('sourceInfo');
            if (data.data.is_real) {
                sourceEl.textContent = '‚úÖ Datos reales de TTN';
                sourceEl.style.color = '#7ee787';
            } else {
                sourceEl.textContent = '‚ö†Ô∏è Modo simulado - Presiona "Consultar TTN API"';
                sourceEl.style.color = '#e3b341';
            }
            
            // Log para depuraci√≥n
            console.log('Display actualizado:', data);
        }
        
        function setStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = 'status ' + type;
            statusEl.innerHTML = message;
        }
        
        function calculateLevel(distance) {
            let liters = TANK.capacity * (TANK.empty - distance) / (TANK.empty - TANK.full);
            if (liters < 0) liters = 0;
            if (liters > TANK.capacity) liters = TANK.capacity;
            
            const percent = Math.round((liters / TANK.capacity) * 100);
            return {
                liters: Math.round(liters),
                percent: percent
            };
        }
        
        function getLevelColor(percent) {
            if (percent >= 60) return '#7ee787'; // Verde
            if (percent >= 20) return '#e3b341'; // Amarillo
            return '#f85149'; // Rojo
        }
        
        function formatTime(timestamp) {
            if (!timestamp || timestamp === 'never') return '--:--:--';
            try {
                const date = new Date(timestamp);
                return date.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (e) {
                return timestamp.substring(11, 19); // Extraer HH:MM:SS
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Monitor Gasoil iniciado');
            console.log('URL del script:', SCRIPT_URL);
            
            // Actualizar inmediatamente
            updateData();
            
            // Auto-actualizar cada 60 segundos
            setInterval(updateData, 60000);
            
            // Mostrar notificaci√≥n de inicio
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });
    </script>
</body>
</html>
