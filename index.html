<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Monitor Gasoil - FINAL</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 500px; margin: 0 auto; background: #2d2d2d; padding: 30px; border-radius: 15px; }
        h1 { color: #4CAF50; text-align: center; }
        .display { background: #000; color: #0f0; font-size: 60px; text-align: center; padding: 30px; margin: 20px 0; border-radius: 10px; font-family: monospace; }
        .info { background: #3d3d3d; padding: 15px; border-radius: 10px; margin: 10px 0; }
        .btn { background: #4285f4; color: white; padding: 15px; width: 100%; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; margin: 10px 0; }
        .btn:hover { background: #3367d6; }
        .status { padding: 10px; border-radius: 5px; text-align: center; }
        .online { background: #1e3a1e; color: #0f0; }
        .offline { background: #3a1e1e; color: #f00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ¢Ô∏è MONITOR GASOIL</h1>
        
        <div id="status" class="status offline">
            ‚ö†Ô∏è Esperando datos del webhook...
        </div>
        
        <div class="display">
            <span id="distance">--</span> mm
        </div>
        
        <div class="info">
            <p><strong>üìä Nivel estimado:</strong> <span id="level">-- L (--%)</span></p>
            <p><strong>üîã Bater√≠a:</strong> <span id="battery">-- V</span></p>
            <p><strong>‚è∞ √öltima lectura:</strong> <span id="time">--:--:--</span></p>
            <p><strong>üì° Fuente:</strong> <span id="source">--</span></p>
        </div>
        
        <button class="btn" onclick="updateData()">üîÑ Actualizar Datos</button>
        <button class="btn" onclick="forceTTNFetch()">‚ö° Forzar Consulta TTN</button>
        <button class="btn" onclick="openWebhookSite()">üîó Ver Webhook.site</button>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxEHHmB9cSJ7H5KUyXvy8GZf98pGPnMWZhYT7OdLHjPw4nXxjORyZf7W_8vm_MJU6_mUg/exec';
        
        // Configuraci√≥n del tanque
        const TANK = {
            full: 120,    // mm cuando est√° lleno
            empty: 1900,  // mm cuando est√° vac√≠o
            capacity: 1100 // litros totales
        };
        
        async function updateData() {
            const status = document.getElementById('status');
            status.className = 'status';
            status.textContent = 'üîÑ Actualizando...';
            
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                // Actualizar display
                document.getElementById('distance').textContent = data.data.distance;
                document.getElementById('battery').textContent = data.data.battery.toFixed(2) + ' V';
                document.getElementById('time').textContent = formatTime(data.data.timestamp);
                document.getElementById('source').textContent = data.data.is_real ? 'TTN Webhook ‚úÖ' : 'Modo Simulado ‚ö†Ô∏è';
                
                // Calcular nivel
                const level = calculateLevel(data.data.distance);
                document.getElementById('level').textContent = `${level.liters} L (${level.percent}%)`;
                
                // Actualizar estado
                if (data.success) {
                    status.className = 'status online';
                    status.innerHTML = '‚úÖ <strong>DATOS REALES</strong> - Conectado a TTN';
                } else {
                    status.className = 'status offline';
                    status.innerHTML = '‚ö†Ô∏è <strong>MODO SIMULADO</strong> - Esperando webhook';
                }
                
                console.log('Datos actualizados:', data);
                
            } catch (error) {
                status.className = 'status offline';
                status.innerHTML = '‚ùå <strong>ERROR</strong> - No se pudo conectar';
                console.error('Error:', error);
            }
        }
        
        async function forceTTNFetch() {
            try {
                const response = await fetch(SCRIPT_URL + '?force=fetch');
                const data = await response.json();
                
                alert(data.message + '\n\nDistancia: ' + (data.data?.distance || 'N/A') + ' mm');
                
                // Actualizar display
                setTimeout(updateData, 1000);
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function openWebhookSite() {
            window.open('https://webhook.site/#!/3562ba16-1b6a-49dc-8cd9-9f088eea31c2', '_blank');
        }
        
        function calculateLevel(distance) {
            let liters = TANK.capacity * (TANK.empty - distance) / (TANK.empty - TANK.full);
            if (liters < 0) liters = 0;
            if (liters > TANK.capacity) liters = TANK.capacity;
            
            const percent = Math.round((liters / TANK.capacity) * 100);
            return {
                liters: Math.round(liters),
                percent: percent
            };
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return '--:--:--';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('es-ES');
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Monitor iniciado');
            updateData(); // Primera actualizaci√≥n
            setInterval(updateData, 30000); // Auto-actualizar cada 30s
        });
    </script>
</body>
</html>
